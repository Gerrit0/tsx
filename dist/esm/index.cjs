"use strict";var F=require("node:worker_threads"),d=require("../node-features-SH6-KdlE.cjs"),O=require("../register-BIOvi1NN.cjs"),c=require("../resolve-ts-path-VlOGJlUT.cjs"),h=require("node:url"),U=require("node:fs/promises"),l=require("../index-DrTak83p.cjs"),_=require("../client-DjommMgI.cjs"),E=require("node:path"),T=require("node:fs");require("node:module"),require("get-tsconfig"),require("esbuild"),require("node:crypto"),require("node:os"),require("../temporary-directory-B83uKxJF.cjs"),require("node:net"),require("../get-pipe-path-b8D5AZgV.cjs");const p={active:!0},v=async e=>{if(!e)throw new Error(`tsx must be loaded with --import instead of --loader
The --loader flag was deprecated in Node v20.6.0 and v18.19.0`);p.namespace=e.namespace,e.tsconfig!==!1&&c.loadTsconfig(e.tsconfig??process.env.TSX_TSCONFIG_PATH),e.port&&(p.port=e.port,e.port.on("message",t=>{t==="deactivate"&&(p.active=!1,e.port.postMessage({type:"deactivated"}))}))},j=()=>(c.loadTsconfig(process.env.TSX_TSCONFIG_PATH),"process.setSourceMapsEnabled(true);"),m=new Map,N=async e=>{if(m.has(e))return m.get(e);if(!await T.promises.access(e).then(()=>!0,()=>!1)){m.set(e,void 0);return}const r=await T.promises.readFile(e,"utf8");try{const a=JSON.parse(r);return m.set(e,a),a}catch{throw new Error(`Error parsing: ${e}`)}},S=async e=>{let t=new URL("package.json",e);for(;!t.pathname.endsWith("/node_modules/package.json");){const r=h.fileURLToPath(t),a=await N(r);if(a)return a;const o=t;if(t=new URL("../package.json",t),t.pathname===o.pathname)break}},M=async e=>(await S(e))?.type??"commonjs",D=e=>{const t=e.indexOf("?");e=t===-1?e:e.slice(0,t);const r=E.extname(e);if(r===".json")return"json";if(r===".mjs"||r===".mts")return"module";if(r===".cjs"||r===".cts")return"commonjs"},I=e=>{const t=D(e);if(t)return t;if(c.tsExtensionsPattern.test(e))return M(e)},f="tsx-namespace=",g=e=>{const t=e.indexOf(f);if(t===-1)return;const r=e[t-1];if(r!=="?"&&r!=="&")return;const a=t+f.length,o=e.indexOf("&",a);return o===-1?e.slice(a):e.slice(a,o)},w=d.isFeatureSupported(d.importAttributes)?"importAttributes":"importAssertions",J=async(e,t,r)=>{if(!p.active||p.namespace&&p.namespace!==g(e))return r(e,t);if(p.port){const n=new URL(e);n.searchParams.delete("tsx-namespace"),p.port.postMessage({type:"load",url:n.toString()})}_.parent.send&&_.parent.send({type:"dependency",path:e}),c.isJsonPattern.test(e)&&(t[w]||(t[w]={}),t[w].type="json");const a=await r(e,t),o=e.startsWith("file://")?h.fileURLToPath(e):e;if(a.format==="commonjs"&&d.isFeatureSupported(d.esmLoadReadFile)){const n=await U.readFile(new URL(e),"utf8"),i=await l.transform(n,o,{format:"cjs",platform:"node",tsconfigRaw:c.fileMatcher?.(o)});return a.responseURL=`data:text/javascript,${encodeURIComponent(i.code)}?tsx-file=${encodeURIComponent(o)}`,a}if(!a.source)return a;const s=a.source.toString();if(a.format==="json"||c.tsExtensionsPattern.test(e)){const n=await l.transform(s,o,{tsconfigRaw:c.fileMatcher?.(o)});return{format:"module",source:c.inlineSourceMap(n)}}if(a.format==="module"){const n=l.transformDynamicImport(o,s);n&&(a.source=c.inlineSourceMap(n))}return a},y=async e=>(!e.format&&e.url.startsWith(c.fileUrlPrefix)&&(e.format=await I(e.url)),e),A=[".js",".json",".ts",".tsx",".jsx"],P=async(e,t,r)=>{const[a,o]=e.split("?");let s;for(const n of A)try{return await y(await r(a+n+(o?`?${o}`:""),t))}catch(i){if(s===void 0&&i instanceof Error){const{message:u}=i;i.message=i.message.replace(`${n}'`,"'"),i.stack=i.stack.replace(u,i.message),s=i}}throw s},R=async(e,t,r)=>{const a=c.isDirectoryPattern.test(e),o=a?"index":"/index",[s,n]=e.split("?");try{return await P(s+o+(n?`?${n}`:""),t,r)}catch(i){if(!a)try{return await P(e,t,r)}catch{}const u=i,{message:k}=u;throw u.message=u.message.replace(`${o.replace("/",E.sep)}'`,"'"),u.stack=u.stack.replace(k,u.message),u}},q=async(e,t,r,a)=>{if(!p.active)return r(e,t);const o=t.parentURL&&g(t.parentURL);if(c.requestAcceptsQuery(e)){let s=g(e);if(o&&!s&&(s=o,e+=`${e.includes("?")?"&":"?"}${f}${o}`),p.namespace&&p.namespace!==s)return r(e,t);if(c.isDirectoryPattern.test(e))return await R(e,t,r)}else if(c.tsconfigPathsMatcher&&!t.parentURL?.includes("/node_modules/")){const s=c.tsconfigPathsMatcher(e);for(const n of s)try{return await q(h.pathToFileURL(n).toString(),t,r)}catch{}}if(c.tsExtensionsPattern.test(t.parentURL)||c.allowJs){const s=c.resolveTsPath(e);if(s)for(const n of s)try{return await y(await r(n,t))}catch(i){const{code:u}=i;if(u!=="ERR_MODULE_NOT_FOUND"&&u!=="ERR_PACKAGE_PATH_NOT_EXPORTED")throw i}}try{const s=await y(await r(e,t));if(c.requestAcceptsQuery(s.url)){const n=g(s.url);o&&!n&&(s.url+=`${s.url.includes("?")?"&":"?"}${f}${o}`)}return s}catch(s){if(s instanceof Error&&!a){const{code:n}=s;if(n==="ERR_UNSUPPORTED_DIR_IMPORT")try{return await R(e,t,r)}catch(i){if(i.code!=="ERR_PACKAGE_IMPORT_NOT_DEFINED")throw i}if(n==="ERR_MODULE_NOT_FOUND")try{return await P(e,t,r)}catch{}}throw s}};d.isFeatureSupported(d.moduleRegister)&&F.isMainThread&&O.register(),exports.globalPreload=j,exports.initialize=v,exports.load=J,exports.resolve=q;
