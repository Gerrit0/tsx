import{isMainThread as S}from"node:worker_threads";import{i as u,a as D,e as M,m as $}from"../node-features-c5LcLQSa.mjs";import{r as A}from"../register-B0bfVVOZ.mjs";import{l,c as g,e as L,i as _,f as E,g as P,h as R,d as b,r as C,a as v,t as T}from"../resolve-ts-path-DUkQ8uuR.mjs";import{fileURLToPath as k,pathToFileURL as q}from"node:url";import{readFile as W}from"node:fs/promises";import{b as O,t as G}from"../index-BA2sSWyo.mjs";import{p as U}from"../client-Cg7nS93t.mjs";import j from"node:path";import N from"node:fs";import"node:module";import"get-tsconfig";import"esbuild";import"node:crypto";import"node:os";import"../temporary-directory-CwHp0_NW.mjs";import"node:net";import"../get-pipe-path-CmcG6VNd.mjs";const m={active:!0},Q=async t=>{if(!t)throw new Error(`tsx must be loaded with --import instead of --loader
The --loader flag was deprecated in Node v20.6.0 and v18.19.0`);m.namespace=t.namespace,t.tsconfig!==!1&&l(t.tsconfig??process.env.TSX_TSCONFIG_PATH),t.port&&(m.port=t.port,t.port.on("message",a=>{a==="deactivate"&&(m.active=!1,t.port.postMessage({type:"deactivated"}))}))},x=()=>(l(process.env.TSX_TSCONFIG_PATH),"process.setSourceMapsEnabled(true);"),p=new Map,H=async t=>{if(p.has(t))return p.get(t);if(!await N.promises.access(t).then(()=>!0,()=>!1)){p.set(t,void 0);return}const e=await N.promises.readFile(t,"utf8");try{const s=JSON.parse(e);return p.set(t,s),s}catch{throw new Error(`Error parsing: ${t}`)}},X=async t=>{let a=new URL("package.json",t);for(;!a.pathname.endsWith("/node_modules/package.json");){const e=k(a),s=await H(e);if(s)return s;const n=a;if(a=new URL("../package.json",a),a.pathname===n.pathname)break}},K=async t=>(await X(t))?.type??"commonjs",z=t=>{const a=t.indexOf("?");t=a===-1?t:t.slice(0,a);const e=j.extname(t);if(e===".json")return"json";if(e===".mjs"||e===".mts")return"module";if(e===".cjs"||e===".cts")return"commonjs"},B=t=>{const a=z(t);if(a)return a;if(g.test(t))return K(t)},f="tsx-namespace=",d=t=>{const a=t.indexOf(f);if(a===-1)return;const e=t[a-1];if(e!=="?"&&e!=="&")return;const s=a+f.length,n=t.indexOf("&",s);return n===-1?t.slice(s):t.slice(s,n)},h=u(D)?"importAttributes":"importAssertions",V=async(t,a,e)=>{if(!m.active||m.namespace&&m.namespace!==d(t))return e(t,a);if(m.port){const o=new URL(t);o.searchParams.delete("tsx-namespace"),m.port.postMessage({type:"load",url:o.toString()})}U.send&&U.send({type:"dependency",path:t}),L.test(t)&&(a[h]||(a[h]={}),a[h].type="json");const s=await e(t,a),n=t.startsWith("file://")?k(t):t;if(s.format==="commonjs"&&u(M)){const o=await W(new URL(t),"utf8"),c=await O(o,n,{format:"cjs",platform:"node",tsconfigRaw:E?.(n)});return s.responseURL=`data:text/javascript,${encodeURIComponent(c.code)}?tsx-file=${encodeURIComponent(n)}`,s}if(!s.source)return s;const r=s.source.toString();if(s.format==="json"||g.test(t)){const o=await O(r,n,{tsconfigRaw:E?.(n)});return{format:"module",source:_(o)}}if(s.format==="module"){const o=G(n,r);o&&(s.source=_(o))}return s},w=async t=>(!t.format&&t.url.startsWith(v)&&(t.format=await B(t.url)),t),Y=[".js",".json",".ts",".tsx",".jsx"],y=async(t,a,e)=>{const[s,n]=t.split("?");let r;for(const o of Y)try{return await w(await e(s+o+(n?`?${n}`:""),a))}catch(c){if(r===void 0&&c instanceof Error){const{message:i}=c;c.message=c.message.replace(`${o}'`,"'"),c.stack=c.stack.replace(i,c.message),r=c}}throw r},F=async(t,a,e)=>{const s=R.test(t),n=s?"index":"/index",[r,o]=t.split("?");try{return await y(r+n+(o?`?${o}`:""),a,e)}catch(c){if(!s)try{return await y(t,a,e)}catch{}const i=c,{message:J}=i;throw i.message=i.message.replace(`${n.replace("/",j.sep)}'`,"'"),i.stack=i.stack.replace(J,i.message),i}},I=async(t,a,e,s)=>{if(!m.active)return e(t,a);const n=a.parentURL&&d(a.parentURL);if(P(t)){let r=d(t);if(n&&!r&&(r=n,t+=`${t.includes("?")?"&":"?"}${f}${n}`),m.namespace&&m.namespace!==r)return e(t,a);if(R.test(t))return await F(t,a,e)}else if(T&&!a.parentURL?.includes("/node_modules/")){const r=T(t);for(const o of r)try{return await I(q(o).toString(),a,e)}catch{}}if(g.test(a.parentURL)||b){const r=C(t);if(r)for(const o of r)try{return await w(await e(o,a))}catch(c){const{code:i}=c;if(i!=="ERR_MODULE_NOT_FOUND"&&i!=="ERR_PACKAGE_PATH_NOT_EXPORTED")throw c}}try{const r=await w(await e(t,a));if(P(r.url)){const o=d(r.url);n&&!o&&(r.url+=`${r.url.includes("?")?"&":"?"}${f}${n}`)}return r}catch(r){if(r instanceof Error&&!s){const{code:o}=r;if(o==="ERR_UNSUPPORTED_DIR_IMPORT")try{return await F(t,a,e)}catch(c){if(c.code!=="ERR_PACKAGE_IMPORT_NOT_DEFINED")throw c}if(o==="ERR_MODULE_NOT_FOUND")try{return await y(t,a,e)}catch{}}throw r}};u($)&&S&&A();export{x as globalPreload,Q as initialize,V as load,I as resolve};
